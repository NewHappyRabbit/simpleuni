<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Програма уни</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <link rel="stylesheet" href="./css/scan-program.css">

</head>

<body>
    <div class="container">
        <span class="split"></span>
        <div id="camera">
            <p>Посочете QR кодът с камерата.</p>
            <video id="qr-video" style="display: none"></video>
        </div>
        <p>или</p>
        <div id="file">
            <label for="file-selector" class="ui-button">Избери снимка с QR код</label>
            <input id="file-selector" accept="image/png" style="visibility:hidden;" type="file">
        </div>
    </div>
    <script type="module">
        import QrScanner from "./scripts/qr-scanner.min.js";
        QrScanner.WORKER_PATH = './scripts/qr-scanner-worker.min.js';

        //check if user has camera (is desktop or mobile)
        QrScanner.hasCamera().then(result => addElements(result ? 'mobile' : 'desktop'));

        function addElements(device) {
            if (device == 'mobile') {
                $('#camera').show();
                window.scanner = scanner;
                scanner.start();
                $('#camera').append(scanner.$canvas);
            }
        }

        // ####### Web Cam Scanning #######
        const video = document.getElementById('qr-video');
        const scanner = new QrScanner(video, result => setResult(result), error => {
            console.log(error);
        }, undefined, 'environment');

        // ####### File Scanning #######
        const fileSelector = document.getElementById('file-selector');
        fileSelector.addEventListener('change', event => {
            const file = fileSelector.files[0];
            if (!file) {
                return;
            }
            QrScanner.scanImage(file)
                .then(result => setResult(result))
            //                .catch(e => errorFound(e));
        });

        function setResult(result) {
            let decodedQR = decodeURIComponent(result);
            scanner.stop();
            if (document.querySelector('#camera canvas'))
                document.querySelector('#camera canvas').remove();

            console.log(decodedQR);
            
            let request = $.ajax({
                type: "GET",
                url: "./temp-jsons/get.php",
                data: {
                    filename: decodedQR
                },
                dataType: 'JSON',
                async: false,
/*                success: function(response) {
                    console.log(response.msg);
                    console.log('yes');
                },
                failed: function(err) {
                    console.log(err);
                    console.log('no');
                }*/
            });
            
            request.done(function(msg){ //if all good
                localStorage.setItem("program", msg.msg);
                alert('Успешно въведен код!');
                window.location.replace("index.html");
            })
            request.fail(function(jqXHR, textStatus) {
                alert('Възникна грешка: ' + textStatus);
            })
        }

    </script>
</body>
